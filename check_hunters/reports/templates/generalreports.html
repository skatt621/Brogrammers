{% extends "base.html" %}
{% load static %}
{% load render_table from django_tables2 %}

{% block stylesheets %}
  <link rel="stylesheet" href="{% static 'css/piechart.css' %}"/>
  <link rel="stylesheet" href="{% static 'css/reports.css' %}"/>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">
  <script type="text/javascript" src="{% static 'js/piechart.js' %}"></script>
{% endblock %}

{% load crispy_forms_tags %}
{% block content %}



  <div class="container">
      <div class="row">
        <div class="col-sm-10 offset-sm-1 offset-md-3 col-md-6">
            <h1>Reports</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-10 offset-sm-1 offset-md-1 col-md-10">
            <div class="graph"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-10 offset-sm-1 offset-md-4 col-md-4">
            <form id="form" method="post">
              {% csrf_token %}
              {{ form|crispy }}
              <button class="btn btn-primary" type="submit" name="Submit" onclick="submitForm()">Submit</button>
            </form>

        </div>
      </div>
  </div>

  <script type="text/javascript">
      var requesturl = "";
      var queryString = "";
      var numQueryStringParameters = 0;

      function submitForm() {
        var i;
        for(i = 1; i < document.getElementById("form").elements.length; ++i){
          if (typeof document.getElementById("form").elements[i] != 'undefined' && document.getElementById("form").elements[i].type !== 'submit') {
              if (numQueryStringParameters === 0){
                 queryString = "";
                 queryString += "?" + document.getElementById("form").elements[i].name + "=" + document.getElementById("form").elements[i].value;
                 numQueryStringParameters++;
              } else {
                queryString += "&" + document.getElementById("form").elements[i].name + "=" + document.getElementById("form").elements[i].value;
                numQueryStringParameters++;
              }
          } else {
              break;
          }
        }

      }

      document.getElementById("form").addEventListener("submit", function(event){
        event.preventDefault();
        numQueryStringParameters = 0;
     });

    var donut = donutChart()
        .width(960)
        .height(500)
        .cornerRadius(3) // sets how rounded the corners are on each slice
        .padAngle(0.015) // effectively dictates the gap between slices
        .variable('Count')
        .category('Name');

    d3.json("{% url 'reports:report_data' %}" + queryString, function(error, data) {
        if (error) throw error;
        d3.select('.graph')
            .datum(data) // bind data to the div
            .call(donut); // draw chart in div
    });
  </script>

{% endblock %}
